name: CI Pipeline & Metrics

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: write

jobs:
  lint:
    name: Ruff Lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libffi-dev

      - name: Install CI dependencies
        run: |
          python -m pip install --upgrade pip
          # Install only minimal packages required for linting and tests to reduce failures
          pip install --prefer-binary -r requirements-ci.txt
          pip install -e .

      - name: Ensure latest ruff
        run: |
          # Some older ruff versions don't support the GitHub formatter flag.
          python -m pip install --upgrade ruff

      - name: Run ruff (annotate PR)
        run: |
          # Fail the job if ruff finds any violations; use GitHub formatter for inline annotations
          python -m ruff check . --output-format=github

  test:
    name: Run Tests and Coverage
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libffi-dev

      - name: Install CI dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --prefer-binary -r requirements-ci.txt
          pip install -e .

      - name: Test Main
        run: pytest tests/test_main.py -v --cov=src --cov-report=term

      - name: Test Metrics Collection
        run: pytest tests/test_metrics.py -v --cov=src --cov-report=term --cov-append

      - name: Test Arbiter Service
        run: pytest tests/test_arbiter/test_service.py -v --cov=src --cov-report=term --cov-append

      - name: Test Database ADSB
        run: pytest tests/test_database/test_adsb_db.py -v --cov=src --cov-report=term --cov-append

      - name: Test Database Subscriber
        run: pytest tests/test_database/test_adsb_subscriber.py -v --cov=src --cov-report=term --cov-append

      - name: Test SDR Capture Publisher
        run: pytest tests/test_sdr_cap/test_adsb_publisher.py -v --cov=src --cov-report=term --cov-append

      - name: Generate Coverage XML Report
        run: coverage xml

      - name: Upload coverage XML
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml-${{ matrix.python-version }}
          path: coverage.xml

  quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libffi-dev

      - name: Install CI dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --prefer-binary -r requirements-ci.txt
          pip install -e .

      - name: Run Radon Complexity Analysis
        run: |
          echo "=== Cyclomatic Complexity ==="
          radon cc src -a -nb
          echo -e "\n=== Maintainability Index ==="
          radon mi src -nb

      - name: Run Radon Duplication Analysis
        run: |
          echo "=== Code Duplication ==="
          radon hal src

      - name: Run Pylint
        run: |
          echo "=== Pylint Analysis ==="
          pylint src --exit-zero --output-format=colorized || true

      - name: Run Bandit Security Scan
        run: |
          echo "=== Security Vulnerability Scan ==="
          bandit -r src -f json -o bandit-report.json || true
          cat bandit-report.json

      - name: Run MyPy Type Checking
        run: |
          echo "=== Type Checking ==="
          mypy src --ignore-missing-imports || true

      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-report
          path: bandit-report.json

  metrics-dashboard:
    name: Generate Metrics Dashboard
    runs-on: ubuntu-latest
    needs: [test, quality]
    if: success()
    permissions:
      contents: write
    strategy:
      matrix:
        python-version: [3.11]
    steps:
      - name: Checkout (with push capability)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libffi-dev

      - name: Install CI dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --prefer-binary -r requirements-ci.txt
          pip install -e .

      - name: Download coverage XML artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-xml-${{ matrix.python-version }}
        continue-on-error: true

      - name: Download bandit report
        uses: actions/download-artifact@v4
        with:
          name: bandit-security-report
        continue-on-error: true

      - name: Generate metrics dashboard
        run: python .github/workflows/update-metrics-dashboard.py

      - name: Commit metrics to main branch
        env:
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          git config user.name "${GIT_COMMITTER_NAME}"
          git config user.email "${GIT_COMMITTER_EMAIL}"
          git add docs/metrics-dashboard.html docs/metrics-history.json
          git commit -m "Update metrics dashboard for ${{ github.sha }}" || echo "no changes to commit"
          git push origin HEAD:${{ github.ref }} || true


